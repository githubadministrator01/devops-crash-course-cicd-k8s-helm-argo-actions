name: CI/CD Parent Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy"
        required: true
      chart_dir:
        description: "Path to the Helm chart in the repo"
        required: true
        default: "./helm/my-node-app-chart"

permissions:        # important for GHCR push
  contents: read
  packages: write

jobs:
  build-test-scan:
    uses: ./.github/workflows/build-test-scan.yaml
    with:
      image_tag: "ghcr.io/${{ github.repository_owner }}/my-node-app:latest"

  deploy:
    needs: build-test-scan
    uses: ./.github/workflows/deploy-helm-argocd.yaml
    with:
      image_tag: "ghcr.io/${{ github.repository_owner }}/my-node-app:latest"
      chart_dir: "./helm/my-node-app-chart"  # path to Helm chart in the repo
